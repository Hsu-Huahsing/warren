#!/usr/bin/env python3# -*- coding: utf-8 -*-# from os import path# import sys# workdir_path=path.dirname(__file__)# sys.path.append(workdir_path)import configuration as cfimport pandas as pdfrom crawl import management,parserfrom multiprocessing import Poolfrom packet import multilisforcrawl,stocktablecrawlfrom traceback import format_excfrom steventricks.file import pickleload,picklesave,data_renewfrom copy import deepcopyfrom os import pathimport sys# a=pickleload("/Users/stevenhsu/Documents/GitHub/trading/log.pkl")stocktable_renew=Trueif __name__ == '__main__' :    m = management()    m.mall    log = m.log    parse_col=m.get_item(title=False)    crawldata = m.dataforparse(col_include=parse_col,key_include=["wait"])    #"badconnection","closed","jsonerror"    multilis = multilisforcrawl(crawldata)    if stocktable_renew == True :        stocktable = stocktablecrawl(timeout=60)        picklesave(path.join(cf.cloud_path,"stocktable.pkl"),stocktable,repl=True)# In[]    try :        with Pool() as p :            for res in p.imap_unordered(parser,multilis):                if "errormessage" in res :                    print(res["stat"])                    print(res["errormessage"])                elif "date" in res["data"]:                    print("資料日期 ==> ",res["data"]["date"])                else:                    print(res["stat"])                log.loc[log[res["item"]].index==res["crawldate"],res["item"]] = res["stat"]                print(log.loc[log[res["item"]].index==res["crawldate"],res["item"]])                # log=c.olderlog_file                # c.olderlog_file.loc["2013-3-21","三大法人買賣金額統計表"]=None                picklesave(m.olderlog_path,log,repl=True)                print("Log renewed .")                # break    except KeyboardInterrupt:        picklesave(m.olderlog_path,log,repl=True)        print("KeyboardInterrupt ... content saving")        print("Log saved .")        sys.exit()    except Exception as e :        print("===============")        print(format_exc())        print("Unknowned error")        print(e)        picklesave(m.olderlog_path,log,repl=True)        print("Log saved .")        sys.exit()